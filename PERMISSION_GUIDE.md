# OAuth 2.0 æƒé™ç®¡ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ¯ æ–°å¢åŠŸèƒ½æ¦‚è§ˆ

ç°åœ¨OAuthæœåŠ¡å™¨æ”¯æŒç»†åˆ†çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼š

### âœ… åŠŸèƒ½ç‰¹æ€§
- **ç”¨æˆ·æƒé™æ£€æŸ¥**ï¼šç”¨æˆ·è®¿é—®åº”ç”¨å‰ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åº”æƒé™
- **æƒé™ç”³è¯·æµç¨‹**ï¼šæ— æƒé™ç”¨æˆ·å¯ä»¥ç”³è¯·è®¿é—®æƒé™
- **ç®¡ç†å‘˜å®¡æ‰¹**ï¼šç®¡ç†å‘˜å¯ä»¥æ‰¹å‡†æˆ–æ‹’ç»æƒé™ç”³è¯·
- **ä½œç”¨åŸŸæ§åˆ¶**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®çš„OAuthä½œç”¨åŸŸ
- **æƒé™è¿‡æœŸ**ï¼šæ”¯æŒè®¾ç½®æƒé™è¿‡æœŸæ—¶é—´
- **æƒé™æ’¤é”€**ï¼šç®¡ç†å‘˜å¯ä»¥éšæ—¶æ’¤é”€ç”¨æˆ·æƒé™

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®
```bash
python init_test_data.py
```
è¿™ä¼šåˆ›å»ºï¼š
- æµ‹è¯•ç”¨æˆ· `testuser` (å¯†ç : `password123`) - **å…·æœ‰ç®¡ç†å‘˜æƒé™**
- æµ‹è¯•OAuthå®¢æˆ·ç«¯åº”ç”¨

### 2. å¯åŠ¨æœåŠ¡
```bash
python main.py
```

### 3. é‡æ–°æ„å»ºå‰ç«¯ï¼ˆå¦‚æœ‰ä¿®æ”¹ï¼‰
```bash
cd frontend && npm run build && cd ..
```

## ğŸ“‹ æƒé™ç®¡ç†æµç¨‹

### ç”¨æˆ·æƒé™ç”³è¯·æµç¨‹

1. **ç”¨æˆ·è®¿é—®OAuthæˆæƒURL**
   ```
   http://localhost:8000/oauth/authorize?response_type=code&client_id=CLIENT_ID&redirect_uri=REDIRECT_URI&scope=openid profile email
   ```

2. **ç³»ç»Ÿæ£€æŸ¥æƒé™**
   - å¦‚æœæœ‰æƒé™ï¼šæ­£å¸¸æ˜¾ç¤ºæˆæƒé¡µé¢
   - å¦‚æœæ— æƒé™ï¼šé‡å®šå‘åˆ°æƒé™ç”³è¯·é¡µé¢

3. **ç”¨æˆ·å¡«å†™ç”³è¯·**
   - è¯´æ˜ç”³è¯·ç†ç”±
   - æäº¤æƒé™ç”³è¯·

4. **ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹**
   - ç®¡ç†å‘˜åœ¨ç®¡ç†åå°å®¡æ ¸ç”³è¯·
   - æ‰¹å‡†æˆ–æ‹’ç»ç”³è¯·

5. **è·å¾—æƒé™åé‡æ–°æˆæƒ**
   - ç”¨æˆ·é‡æ–°è®¿é—®OAuthæˆæƒURL
   - ç³»ç»ŸéªŒè¯æƒé™åæ˜¾ç¤ºæˆæƒé¡µé¢

### ç®¡ç†å‘˜ç®¡ç†æµç¨‹

1. **è®¿é—®ç®¡ç†åå°**
   ```
   http://localhost:8000/admin/permissions
   ```
   (éœ€è¦ç®¡ç†å‘˜æƒé™)

2. **å®¡æ ¸æƒé™ç”³è¯·**
   - æŸ¥çœ‹ç”¨æˆ·ç”³è¯·è¯¦æƒ…
   - ç‚¹å‡»"æ‰¹å‡†"æˆ–"æ‹’ç»"
   - ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæƒé™è®°å½•

## ğŸ”§ APIç«¯ç‚¹è¯´æ˜

### æƒé™æ£€æŸ¥
```http
POST /api/v1/permissions/check
Content-Type: application/json

{
  "user_id": "user_uuid",
  "client_id": "client_uuid", 
  "requested_scopes": ["openid", "profile", "email"]
}
```

### åˆ›å»ºæƒé™ç”³è¯·
```http
POST /api/v1/permissions/requests
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "client_id": "client_uuid",
  "requested_scopes": ["openid", "profile", "email"],
  "request_reason": "éœ€è¦è®¿é—®ç”¨æˆ·åŸºæœ¬ä¿¡æ¯"
}
```

### å®¡æ‰¹æƒé™ç”³è¯·ï¼ˆç®¡ç†å‘˜ï¼‰
```http
PUT /api/v1/permissions/requests/{request_id}
Authorization: Bearer {admin_access_token}
Content-Type: application/json

{
  "status": "approved",
  "review_reason": "ç”³è¯·åˆç†ï¼Œäºˆä»¥æ‰¹å‡†"
}
```

### åˆ›å»ºç”¨æˆ·æƒé™ï¼ˆç®¡ç†å‘˜ï¼‰
```http
POST /api/v1/permissions/
Authorization: Bearer {admin_access_token}
Content-Type: application/json

{
  "user_id": "user_uuid",
  "client_id": "client_uuid",
  "is_allowed": true,
  "is_blocked": false,
  "allowed_scopes": ["openid", "profile", "email"],
  "approval_reason": "ç®¡ç†å‘˜ç›´æ¥æˆæƒ"
}
```

## ğŸ”’ æƒé™çŠ¶æ€è¯´æ˜

### æƒé™è®°å½•å­—æ®µ
- `is_allowed`: æ˜¯å¦å…è®¸è®¿é—®ï¼ˆbooleanï¼‰
- `is_blocked`: æ˜¯å¦è¢«é˜»æ­¢ï¼ˆbooleanï¼‰ 
- `allowed_scopes`: å…è®¸çš„ä½œç”¨åŸŸåˆ—è¡¨
- `denied_scopes`: æ‹’ç»çš„ä½œç”¨åŸŸåˆ—è¡¨
- `expires_at`: æƒé™è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰

### æƒé™æ£€æŸ¥é€»è¾‘
1. æ— æƒé™è®°å½• â†’ éœ€è¦ç”³è¯·æƒé™
2. `is_blocked = true` â†’ è¢«ç¦æ­¢ä½¿ç”¨ï¼Œä¸èƒ½ç”³è¯·
3. `is_allowed = false` â†’ éœ€è¦ç”³è¯·æƒé™
4. `expires_at` å·²è¿‡æœŸ â†’ éœ€è¦é‡æ–°ç”³è¯·
5. æ£€æŸ¥å…·ä½“ä½œç”¨åŸŸæƒé™

## ğŸ¨ å‰ç«¯é¡µé¢

- **æƒé™ç”³è¯·é¡µé¢**: `/permission-request`
- **ç®¡ç†å‘˜å®¡æ‰¹é¡µé¢**: `/admin/permissions` 
- **å›è°ƒå¤„ç†é¡µé¢**: `/callback`

## ğŸ“Š æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡è®¿é—®åº”ç”¨
1. ç”¨æˆ·ç‚¹å‡»OAuthæˆæƒé“¾æ¥
2. ç³»ç»Ÿæ£€æµ‹åˆ°æ— æƒé™ï¼Œé‡å®šå‘åˆ°ç”³è¯·é¡µé¢
3. ç”¨æˆ·å¡«å†™ç”³è¯·ç†ç”±å¹¶æäº¤
4. ç®¡ç†å‘˜å®¡æ‰¹é€šè¿‡
5. ç”¨æˆ·é‡æ–°è®¿é—®æˆæƒé“¾æ¥ï¼Œæ­£å¸¸æ˜¾ç¤ºæˆæƒé¡µé¢

### åœºæ™¯2ï¼šæƒé™è¢«æ‹’ç»
1. ç”¨æˆ·æäº¤æƒé™ç”³è¯·
2. ç®¡ç†å‘˜æ‹’ç»ç”³è¯·
3. ç”¨æˆ·é‡æ–°è®¿é—®ä¼šæ˜¾ç¤º"æŠ±æ­‰æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªåº”ç”¨çš„æƒé™"

### åœºæ™¯3ï¼šç®¡ç†å‘˜ç›´æ¥æˆæƒ
1. ç®¡ç†å‘˜é€šè¿‡APIç›´æ¥ä¸ºç”¨æˆ·åˆ›å»ºæƒé™
2. ç”¨æˆ·è®¿é—®OAuthæˆæƒé“¾æ¥æ—¶ç›´æ¥æ˜¾ç¤ºæˆæƒé¡µé¢

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### æƒé™ç­–ç•¥
å¯ä»¥åœ¨ `PermissionService.check_user_permission` æ–¹æ³•ä¸­ä¿®æ”¹æƒé™æ£€æŸ¥é€»è¾‘

### UIå®šåˆ¶
å‰ç«¯é¡µé¢ä½¿ç”¨Tailwind CSSï¼Œå¯ä»¥è½»æ¾ä¿®æ”¹æ ·å¼å’Œå¸ƒå±€

### ä½œç”¨åŸŸæè¿°
åœ¨å‰ç«¯é¡µé¢çš„ `getScopeDescription` å‡½æ•°ä¸­æ·»åŠ æ›´å¤šä½œç”¨åŸŸæè¿°

---

ç°åœ¨ä½ æ‹¥æœ‰äº†ä¸€ä¸ª**å®Œæ•´çš„OAuth 2.0æƒé™ç®¡ç†ç³»ç»Ÿ**ï¼ğŸš€