(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[674],{5600:function(e,s,a){Promise.resolve().then(a.bind(a,4233))},4233:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return UserManagePage}});var t=a(7437),r=a(2265),l=a(4033),n=a(6454);function UserManagePage(){let e=(0,l.useRouter)();(0,l.useSearchParams)();let[s,a]=(0,r.useState)([]),[i,o]=(0,r.useState)(null),[d,c]=(0,r.useState)(!0),[u,m]=(0,r.useState)(!1),[x,p]=(0,r.useState)("list"),[h,g]=(0,r.useState)({email:"",username:"",password:"",full_name:"",given_name:"",family_name:"",nickname:"",phone_number:"",website:"",gender:"",birthdate:"",locale:"",is_admin:!1,is_active:!0});(0,r.useEffect)(()=>{checkAdmin(),loadUsers()},[]);let checkAdmin=async()=>{try{var s;let a=await fetch("/api/v1/users/me",{headers:{Authorization:"Bearer ".concat(null===(s=document.cookie.match(/access_token=([^;]+)/))||void 0===s?void 0:s[1])}});if(a.ok){let s=await a.json();if(!s.is_admin){e.push("/dashboard");return}}else{e.push("/login");return}}catch(s){console.error("Failed to check admin status:",s),e.push("/login");return}c(!1)},loadUsers=async()=>{try{let e=await n.i.getAllUsers();a(e)}catch(e){console.error("Failed to load users:",e)}},handleEdit=e=>{p("edit"),o(e),g({email:e.email,username:e.username,password:"",full_name:e.full_name||"",given_name:e.given_name||"",family_name:e.family_name||"",nickname:e.nickname||"",phone_number:e.phone_number||"",website:e.website||"",gender:e.gender||"",birthdate:e.birthdate||"",locale:e.locale||"",is_admin:e.is_admin,is_active:e.is_active})},handleSubmit=async()=>{if(!h.email||!h.username){alert("请填写邮箱和用户名");return}if("create"===x&&!h.password){alert("请填写密码");return}m(!0);try{if("create"===x)await n.i.register(h),alert("用户创建成功！");else if("edit"===x&&i){let e={...h};e.password||delete e.password,await n.i.updateUser(i.id,e),alert("用户更新成功！")}p("list"),loadUsers()}catch(a){var e,s;console.error("Failed to save user:",a),alert((null===(s=a.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.detail)||"操作失败，请重试")}finally{m(!1)}},handleDelete=async(e,s)=>{if(confirm('确定要删除用户 "'.concat(s,'" 吗？此操作不可撤销。')))try{await n.i.deleteUser(e),alert("用户删除成功！"),loadUsers()}catch(e){var a,t;console.error("Failed to delete user:",e),alert((null===(t=e.response)||void 0===t?void 0:null===(a=t.data)||void 0===a?void 0:a.detail)||"删除失败，请重试")}};return d?(0,t.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,t.jsx)("p",{className:"mt-4 text-gray-600",children:"加载中..."})]})}):(0,t.jsxs)("div",{className:"min-h-full bg-gray-50",children:[(0,t.jsx)("div",{className:"bg-white shadow",children:(0,t.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)("button",{onClick:()=>e.push("/admin/dashboard"),className:"text-gray-500 hover:text-gray-700",children:(0,t.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"list"===x?"用户管理":"create"===x?"创建用户":"编辑用户"})]}),"list"===x&&(0,t.jsx)("button",{onClick:()=>{p("create"),g({email:"",username:"",password:"",full_name:"",given_name:"",family_name:"",nickname:"",phone_number:"",website:"",gender:"",birthdate:"",locale:"",is_admin:!1,is_active:!0})},className:"btn-primary",children:"创建用户"})]})})}),(0,t.jsx)("div",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"px-4 py-6 sm:px-0",children:["list"===x&&(0,t.jsx)("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:(0,t.jsx)("ul",{className:"divide-y divide-gray-200",children:s.map(e=>(0,t.jsx)("li",{children:(0,t.jsxs)("div",{className:"px-4 py-4 flex items-center justify-between",children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e.full_name||e.username}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:e.email}),(0,t.jsxs)("p",{className:"text-xs text-gray-400",children:["创建时间: ",new Date(e.created_at).toLocaleString()]})]}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[e.is_admin&&(0,t.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:"管理员"}),(0,t.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(e.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.is_active?"活跃":"禁用"})]})]})}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsx)("button",{onClick:()=>handleEdit(e),className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"编辑"}),(0,t.jsx)("button",{onClick:()=>handleDelete(e.id,e.username),className:"px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700",children:"删除"})]})]})},e.id))})}),("create"===x||"edit"===x)&&(0,t.jsx)("div",{className:"bg-white shadow sm:rounded-lg",children:(0,t.jsxs)("div",{className:"px-4 py-5 sm:p-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 gap-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"基本信息"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"邮箱 *"}),(0,t.jsx)("input",{type:"email",value:h.email,onChange:e=>g({...h,email:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"用户名 *"}),(0,t.jsx)("input",{type:"text",value:h.username,onChange:e=>g({...h,username:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),"create"===x&&(0,t.jsxs)("div",{className:"md:col-span-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"密码 *"}),(0,t.jsx)("input",{type:"password",value:h.password,onChange:e=>g({...h,password:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),"edit"===x&&(0,t.jsxs)("div",{className:"md:col-span-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"新密码 (留空则不修改)"}),(0,t.jsx)("input",{type:"password",value:h.password,onChange:e=>g({...h,password:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"留空则不修改密码"})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"个人信息"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"全名"}),(0,t.jsx)("input",{type:"text",value:h.full_name,onChange:e=>g({...h,full_name:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"昵称"}),(0,t.jsx)("input",{type:"text",value:h.nickname,onChange:e=>g({...h,nickname:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"名字"}),(0,t.jsx)("input",{type:"text",value:h.given_name,onChange:e=>g({...h,given_name:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"姓氏"}),(0,t.jsx)("input",{type:"text",value:h.family_name,onChange:e=>g({...h,family_name:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"联系信息"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"手机号码"}),(0,t.jsx)("input",{type:"tel",value:h.phone_number,onChange:e=>g({...h,phone_number:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"个人网站"}),(0,t.jsx)("input",{type:"url",value:h.website,onChange:e=>g({...h,website:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"个人详情"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"性别"}),(0,t.jsxs)("select",{value:h.gender,onChange:e=>g({...h,gender:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,t.jsx)("option",{value:"",children:"选择性别"}),(0,t.jsx)("option",{value:"male",children:"男"}),(0,t.jsx)("option",{value:"female",children:"女"}),(0,t.jsx)("option",{value:"other",children:"其他"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"出生日期"}),(0,t.jsx)("input",{type:"date",value:h.birthdate,onChange:e=>g({...h,birthdate:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"语言"}),(0,t.jsxs)("select",{value:h.locale,onChange:e=>g({...h,locale:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,t.jsx)("option",{value:"",children:"选择语言"}),(0,t.jsx)("option",{value:"zh-CN",children:"中文（简体）"}),(0,t.jsx)("option",{value:"zh-TW",children:"中文（繁體）"}),(0,t.jsx)("option",{value:"en-US",children:"English (US)"}),(0,t.jsx)("option",{value:"en-GB",children:"English (UK)"}),(0,t.jsx)("option",{value:"ja-JP",children:"日本語"}),(0,t.jsx)("option",{value:"ko-KR",children:"한국어"})]})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"账户设置"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("input",{type:"checkbox",id:"is_active",checked:h.is_active,onChange:e=>g({...h,is_active:e.target.checked}),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,t.jsx)("label",{htmlFor:"is_active",className:"ml-2 block text-sm text-gray-900",children:"启用账户"})]}),(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("input",{type:"checkbox",id:"is_admin",checked:h.is_admin,onChange:e=>g({...h,is_admin:e.target.checked}),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,t.jsx)("label",{htmlFor:"is_admin",className:"ml-2 block text-sm text-gray-900",children:"管理员权限"})]})]})]})]}),(0,t.jsxs)("div",{className:"mt-8 flex justify-end space-x-3",children:[(0,t.jsx)("button",{onClick:()=>p("list"),className:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400",children:"取消"}),(0,t.jsx)("button",{onClick:handleSubmit,disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:u?"保存中...":"create"===x?"创建用户":"更新用户"})]})]})})]})})]})}},6454:function(e,s,a){"use strict";a.d(s,{i:function(){return i}});var t=a(4829),r=a(1490);let l="".concat(window.location.protocol,"//").concat(window.location.host),n=t.Z.create({baseURL:l,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{let s=r.Z.get("access_token");return s&&(e.headers.Authorization="Bearer ".concat(s)),e}),n.interceptors.response.use(e=>e,e=>{var s;return(null===(s=e.response)||void 0===s?void 0:s.status)!==401||(r.Z.remove("access_token"),r.Z.remove("refresh_token"),window.location.pathname.includes("/login")||(window.location.href="/login/")),Promise.reject(e)});let i={login:async e=>{let s=new FormData;s.append("username",e.username),s.append("password",e.password),s.append("grant_type","password");let a=await t.Z.post("".concat(l,"/oauth/token"),s,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return a.data},authorize:async e=>{let s=new FormData;Object.entries(e).forEach(e=>{let[a,t]=e;null!=t&&s.append(a,t.toString())});let a=await t.Z.post("".concat(l,"/oauth/authorize"),s,{headers:{"Content-Type":"application/x-www-form-urlencoded"},maxRedirects:0,validateStatus:e=>e<400||e>=300&&e<400});return a},getCurrentUser:async()=>{let e=await n.get("/api/v1/users/me");return e.data},getClientInfo:async e=>{let s=await n.get("/api/v1/clients/".concat(e));return s.data},register:async e=>{let s=await n.post("/api/v1/users",e);return s.data},checkPermission:async(e,s,a)=>{let t=await n.post("/api/v1/permissions/check",{user_id:e,client_id:s,requested_scopes:a});return t.data},createPermissionRequest:async e=>{let s=await n.post("/api/v1/permissions/requests",e);return s.data},getMyPermissionRequests:async()=>{let e=await n.get("/api/v1/permissions/requests/my");return e.data},getUserPermissions:async e=>{let s=await n.get("/api/v1/permissions/user/".concat(e));return s.data},getAllUsers:async()=>{let e=await n.get("/api/v1/users");return e.data},getUserById:async e=>{let s=await n.get("/api/v1/users/".concat(e));return s.data},updateUser:async(e,s)=>{let a=await n.put("/api/v1/users/".concat(e),s);return a.data},deleteUser:async e=>{let s=await n.delete("/api/v1/users/".concat(e));return s.data},getAllClients:async()=>{let e=await n.get("/api/v1/clients");return e.data},updateClient:async(e,s)=>{let a=await n.put("/api/v1/clients/".concat(e),s);return a.data},deleteClient:async e=>{let s=await n.delete("/api/v1/clients/".concat(e));return s.data},createClient:async e=>{let s=await n.post("/api/v1/clients",e);return s.data},getUserPermissionsByAdmin:async e=>{let s=await n.get("/api/v1/admin/users/".concat(e,"/permissions"));return s.data},grantUserPermission:async(e,s,a)=>{let t=await n.post("/api/v1/admin/users/".concat(e,"/permissions/").concat(s),a);return t.data},revokeUserPermission:async(e,s)=>{let a=await n.delete("/api/v1/admin/users/".concat(e,"/permissions/").concat(s));return a.data},getPermissionGroups:async()=>{let e=await n.get("/api/v1/permissions/groups");return e.data},getPermissionGroup:async e=>{let s=await n.get("/api/v1/permissions/groups/".concat(e));return s.data},updatePermissionGroup:async(e,s)=>{let a=await n.put("/api/v1/permissions/groups/".concat(e),s);return a.data}}}},function(e){e.O(0,[745,971,472,744],function(){return e(e.s=5600)}),_N_E=e.O()}]);