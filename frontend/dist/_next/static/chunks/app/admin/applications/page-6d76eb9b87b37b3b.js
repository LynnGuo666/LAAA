(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[602],{2150:function(e,t,s){Promise.resolve().then(s.bind(s,2829))},2829:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ApplicationManagePage}});var a=s(7437),r=s(2265),i=s(4033),n=s(6454);function ApplicationManagePage(){let e=(0,i.useRouter)();(0,i.useSearchParams)();let[t,s]=(0,r.useState)([]),[l,c]=(0,r.useState)(null),[o,d]=(0,r.useState)(!0),[u,m]=(0,r.useState)(!1),[p,x]=(0,r.useState)("list"),[h,g]=(0,r.useState)({client_name:"",client_description:"",client_uri:"",logo_uri:"",tos_uri:"",policy_uri:"",redirect_uris:[""],contacts:[""],scope:"openid profile email",response_types:"code",grant_types:"authorization_code,refresh_token",is_active:!0});(0,r.useEffect)(()=>{checkAdmin(),loadApplications()},[]);let checkAdmin=async()=>{try{var t;let s=await fetch("/api/v1/users/me",{headers:{Authorization:"Bearer ".concat(null===(t=document.cookie.match(/access_token=([^;]+)/))||void 0===t?void 0:t[1])}});if(s.ok){let t=await s.json();if(!t.is_admin){e.push("/dashboard");return}}else{e.push("/login");return}}catch(t){console.error("Failed to check admin status:",t),e.push("/login");return}d(!1)},loadApplications=async()=>{try{let e=await n.i.getAllClients();s(e)}catch(e){console.error("Failed to load applications:",e)}},handleEdit=e=>{x("edit"),c(e),g({client_name:e.client_name,client_description:e.client_description||"",client_uri:e.client_uri||"",logo_uri:e.logo_uri||"",tos_uri:e.tos_uri||"",policy_uri:e.policy_uri||"",redirect_uris:Array.isArray(e.redirect_uris)?e.redirect_uris:"string"==typeof e.redirect_uris?[e.redirect_uris]:[""],contacts:Array.isArray(e.contacts)?e.contacts:"string"==typeof e.contacts?[e.contacts]:[""],scope:e.scope||"openid profile email",response_types:e.response_types||"code",grant_types:e.grant_types||"authorization_code,refresh_token",is_active:e.is_active})},handleSubmit=async()=>{if(!h.client_name){alert("请填写应用名称");return}if(0===h.redirect_uris.filter(e=>e.trim()).length){alert("请至少添加一个重定向URI");return}m(!0);try{let e={...h,redirect_uris:h.redirect_uris.filter(e=>""!==e.trim()),contacts:h.contacts.filter(e=>""!==e.trim())};"create"===p?(await n.i.createClient(e),alert("应用创建成功！")):"edit"===p&&l&&(await n.i.updateClient(l.id,e),alert("应用更新成功！")),x("list"),loadApplications()}catch(s){var e,t;console.error("Failed to save application:",s),alert((null===(t=s.response)||void 0===t?void 0:null===(e=t.data)||void 0===e?void 0:e.detail)||"操作失败，请重试")}finally{m(!1)}},handleDelete=async(e,t)=>{if(confirm('确定要删除应用 "'.concat(t,'" 吗？此操作不可撤销。')))try{await n.i.deleteClient(e),alert("应用删除成功！"),loadApplications()}catch(e){var s,a;console.error("Failed to delete application:",e),alert((null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.detail)||"删除失败，请重试")}},removeRedirectUri=e=>{if(h.redirect_uris.length>1){let t=h.redirect_uris.filter((t,s)=>s!==e);g({...h,redirect_uris:t})}},updateRedirectUri=(e,t)=>{let s=[...h.redirect_uris];s[e]=t,g({...h,redirect_uris:s})},removeContact=e=>{if(h.contacts.length>1){let t=h.contacts.filter((t,s)=>s!==e);g({...h,contacts:t})}},updateContact=(e,t)=>{let s=[...h.contacts];s[e]=t,g({...h,contacts:s})};return o?(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"加载中..."})]})}):(0,a.jsxs)("div",{className:"min-h-full bg-gray-50",children:[(0,a.jsx)("div",{className:"bg-white shadow",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("button",{onClick:()=>e.push("/admin/dashboard"),className:"text-gray-500 hover:text-gray-700",children:(0,a.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"list"===p?"应用管理":"create"===p?"创建应用":"编辑应用"})]}),"list"===p&&(0,a.jsx)("button",{onClick:()=>{x("create"),g({client_name:"",client_description:"",client_uri:"",logo_uri:"",tos_uri:"",policy_uri:"",redirect_uris:[""],contacts:[""],scope:"openid profile email",response_types:"code",grant_types:"authorization_code,refresh_token",is_active:!0})},className:"btn-primary",children:"创建应用"})]})})}),(0,a.jsx)("div",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"px-4 py-6 sm:px-0",children:["list"===p&&(0,a.jsx)("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:(0,a.jsx)("ul",{className:"divide-y divide-gray-200",children:t.map(e=>{var t;return(0,a.jsx)("li",{children:(0,a.jsxs)("div",{className:"px-4 py-4 flex items-center justify-between",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e.client_name}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:e.client_description}),(0,a.jsxs)("p",{className:"text-xs text-gray-400",children:["客户端ID: ",e.client_id," | 所有者: ",null===(t=e.owner)||void 0===t?void 0:t.username]}),(0,a.jsxs)("p",{className:"text-xs text-gray-400",children:["创建时间: ",new Date(e.created_at).toLocaleString()]})]}),(0,a.jsx)("div",{className:"flex space-x-2",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(e.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.is_active?"活跃":"禁用"})})]})}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>handleEdit(e),className:"px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700",children:"编辑"}),(0,a.jsx)("button",{onClick:()=>handleDelete(e.id,e.client_name),className:"px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700",children:"删除"})]})]})},e.id)})})}),("create"===p||"edit"===p)&&(0,a.jsx)("div",{className:"bg-white shadow sm:rounded-lg",children:(0,a.jsxs)("div",{className:"px-4 py-5 sm:p-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"基本信息"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"应用名称 *"}),(0,a.jsx)("input",{type:"text",value:h.client_name,onChange:e=>g({...h,client_name:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"应用官网"}),(0,a.jsx)("input",{type:"url",value:h.client_uri,onChange:e=>g({...h,client_uri:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"应用描述"}),(0,a.jsx)("textarea",{rows:3,value:h.client_description,onChange:e=>g({...h,client_description:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"重定向URI *"}),(0,a.jsxs)("div",{className:"space-y-2",children:[h.redirect_uris.map((e,t)=>(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"url",value:e,onChange:e=>updateRedirectUri(t,e.target.value),placeholder:"https://example.com/callback",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"}),h.redirect_uris.length>1&&(0,a.jsx)("button",{type:"button",onClick:()=>removeRedirectUri(t),className:"px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600",children:"删除"})]},t)),(0,a.jsx)("button",{type:"button",onClick:()=>{g({...h,redirect_uris:[...h.redirect_uris,""]})},className:"px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600",children:"添加重定向URI"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"联系信息"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"联系邮箱"}),h.contacts.map((e,t)=>(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"email",value:e,onChange:e=>updateContact(t,e.target.value),placeholder:"contact@example.com",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"}),h.contacts.length>1&&(0,a.jsx)("button",{type:"button",onClick:()=>removeContact(t),className:"px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600",children:"删除"})]},t)),(0,a.jsx)("button",{type:"button",onClick:()=>{g({...h,contacts:[...h.contacts,""]})},className:"px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600",children:"添加邮箱"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"资源链接"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"应用图标URL"}),(0,a.jsx)("input",{type:"url",value:h.logo_uri,onChange:e=>g({...h,logo_uri:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"服务条款URL"}),(0,a.jsx)("input",{type:"url",value:h.tos_uri,onChange:e=>g({...h,tos_uri:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"隐私政策URL"}),(0,a.jsx)("input",{type:"url",value:h.policy_uri,onChange:e=>g({...h,policy_uri:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"OAuth配置"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"授权范围"}),(0,a.jsx)("input",{type:"text",value:h.scope,onChange:e=>g({...h,scope:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"响应类型"}),(0,a.jsx)("input",{type:"text",value:h.response_types,onChange:e=>g({...h,response_types:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"授权类型"}),(0,a.jsx)("input",{type:"text",value:h.grant_types,onChange:e=>g({...h,grant_types:e.target.value}),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"应用状态"}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",id:"is_active",checked:h.is_active,onChange:e=>g({...h,is_active:e.target.checked}),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,a.jsx)("label",{htmlFor:"is_active",className:"ml-2 block text-sm text-gray-900",children:"启用应用"})]})]})]}),(0,a.jsxs)("div",{className:"mt-8 flex justify-end space-x-3",children:[(0,a.jsx)("button",{onClick:()=>x("list"),className:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400",children:"取消"}),(0,a.jsx)("button",{onClick:handleSubmit,disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:u?"保存中...":"create"===p?"创建应用":"更新应用"})]})]})})]})})]})}},6454:function(e,t,s){"use strict";s.d(t,{i:function(){return l}});var a=s(4829),r=s(1490);let i="".concat(window.location.protocol,"//").concat(window.location.host),n=a.Z.create({baseURL:i,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{let t=r.Z.get("access_token");return t&&(e.headers.Authorization="Bearer ".concat(t)),e}),n.interceptors.response.use(e=>e,e=>{var t;return(null===(t=e.response)||void 0===t?void 0:t.status)!==401||(r.Z.remove("access_token"),r.Z.remove("refresh_token"),window.location.pathname.includes("/login")||(window.location.href="/login/")),Promise.reject(e)});let l={login:async e=>{let t=new FormData;t.append("username",e.username),t.append("password",e.password),t.append("grant_type","password");let s=await a.Z.post("".concat(i,"/oauth/token"),t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return s.data},authorize:async e=>{let t=new FormData;Object.entries(e).forEach(e=>{let[s,a]=e;null!=a&&t.append(s,a.toString())});let s=await a.Z.post("".concat(i,"/oauth/authorize"),t,{headers:{"Content-Type":"application/x-www-form-urlencoded"},maxRedirects:0,validateStatus:e=>e<400||e>=300&&e<400});return s},getCurrentUser:async()=>{let e=await n.get("/api/v1/users/me");return e.data},getClientInfo:async e=>{let t=await n.get("/api/v1/clients/".concat(e));return t.data},register:async e=>{let t=await n.post("/api/v1/users",e);return t.data},checkPermission:async(e,t,s)=>{let a=await n.post("/api/v1/permissions/check",{user_id:e,client_id:t,requested_scopes:s});return a.data},createPermissionRequest:async e=>{let t=await n.post("/api/v1/permissions/requests",e);return t.data},getMyPermissionRequests:async()=>{let e=await n.get("/api/v1/permissions/requests/my");return e.data},getUserPermissions:async e=>{let t=await n.get("/api/v1/permissions/user/".concat(e));return t.data},getAllUsers:async()=>{let e=await n.get("/api/v1/users");return e.data},getUserById:async e=>{let t=await n.get("/api/v1/users/".concat(e));return t.data},updateUser:async(e,t)=>{let s=await n.put("/api/v1/users/".concat(e),t);return s.data},deleteUser:async e=>{let t=await n.delete("/api/v1/users/".concat(e));return t.data},getAllClients:async()=>{let e=await n.get("/api/v1/clients");return e.data},updateClient:async(e,t)=>{let s=await n.put("/api/v1/clients/".concat(e),t);return s.data},deleteClient:async e=>{let t=await n.delete("/api/v1/clients/".concat(e));return t.data},createClient:async e=>{let t=await n.post("/api/v1/clients",e);return t.data},getUserPermissionsByAdmin:async e=>{let t=await n.get("/api/v1/admin/users/".concat(e,"/permissions"));return t.data},grantUserPermission:async(e,t,s)=>{let a=await n.post("/api/v1/admin/users/".concat(e,"/permissions/").concat(t),s);return a.data},revokeUserPermission:async(e,t)=>{let s=await n.delete("/api/v1/admin/users/".concat(e,"/permissions/").concat(t));return s.data},getPermissionGroups:async()=>{let e=await n.get("/api/v1/permissions/groups");return e.data},getPermissionGroup:async e=>{let t=await n.get("/api/v1/permissions/groups/".concat(e));return t.data},updatePermissionGroup:async(e,t)=>{let s=await n.put("/api/v1/permissions/groups/".concat(e),t);return s.data}}}},function(e){e.O(0,[745,971,472,744],function(){return e(e.s=2150)}),_N_E=e.O()}]);