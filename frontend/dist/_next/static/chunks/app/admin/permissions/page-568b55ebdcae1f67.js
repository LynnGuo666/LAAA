(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[944],{8054:function(e,s,t){Promise.resolve().then(t.bind(t,3515))},3515:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return AdminPermissionsPage}});var a=t(7437),l=t(2265);function AdminPermissionsPage(){let[e,s]=(0,l.useState)([]),[t,r]=(0,l.useState)(null),[i,c]=(0,l.useState)(null),[o,n]=(0,l.useState)([]),[d,m]=(0,l.useState)([]),[u,x]=(0,l.useState)(!0),[h,p]=(0,l.useState)(!1),[g,f]=(0,l.useState)("默认权限组"),[v,y]=(0,l.useState)(""),[b,j]=(0,l.useState)(!1),[N,w]=(0,l.useState)(["openid","profile","email"]),[k,_]=(0,l.useState)(!1),[S,C]=(0,l.useState)(""),[E,P]=(0,l.useState)("allowed"),[A,O]=(0,l.useState)([]),[F,B]=(0,l.useState)(""),z=["openid","profile","email","phone","address"];(0,l.useEffect)(()=>{loadClients(),loadUsers()},[]),(0,l.useEffect)(()=>{t&&loadClientPermissions(t.client_id)},[t]);let loadClients=async()=>{try{var e;let t=await fetch("/api/v1/clients",{headers:{Authorization:"Bearer ".concat(null===(e=document.cookie.match(/access_token=([^;]+)/))||void 0===e?void 0:e[1])}});if(t.ok){let e=await t.json();s(e),e.length>0&&r(e[0])}}catch(e){console.error("Failed to load clients:",e)}finally{x(!1)}},loadUsers=async()=>{try{var e;let s=await fetch("/api/v1/users",{headers:{Authorization:"Bearer ".concat(null===(e=document.cookie.match(/access_token=([^;]+)/))||void 0===e?void 0:e[1])}});if(s.ok){let e=await s.json();m(e)}}catch(e){console.error("Failed to load users:",e)}},loadClientPermissions=async e=>{try{var s,t;try{let t=await fetch("/api/v1/permissions/groups/".concat(e),{headers:{Authorization:"Bearer ".concat(null===(s=document.cookie.match(/access_token=([^;]+)/))||void 0===s?void 0:s[1])}});if(t.ok){let e=await t.json();c(e),f(e.name||"默认权限组"),y(e.description||""),j(e.default_allowed||!1),w(e.allowed_scopes||["openid","profile","email"])}else c(null),f("默认权限组"),y(""),j(!1),w(["openid","profile","email"])}catch(e){console.error("Failed to load permission group:",e)}try{let s=await fetch("/api/v1/permissions/access/".concat(e),{headers:{Authorization:"Bearer ".concat(null===(t=document.cookie.match(/access_token=([^;]+)/))||void 0===t?void 0:t[1])}});if(s.ok){let e=await s.json();n(e.user_accesses||[])}}catch(e){console.error("Failed to load user accesses:",e)}}catch(e){console.error("Failed to load client permissions:",e)}},savePermissionGroup=async()=>{if(t){p(!0);try{var e;let s=await fetch("/api/v1/permissions/groups/".concat(t.client_id),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(null===(e=document.cookie.match(/access_token=([^;]+)/))||void 0===e?void 0:e[1])},body:JSON.stringify({name:g,description:v,default_allowed:b,allowed_scopes:N})});if(s.ok){let e=await s.json();c(e),alert("权限组保存成功！")}else throw Error("保存失败")}catch(e){console.error("Failed to save permission group:",e),alert("保存权限组失败")}finally{p(!1)}}},grantUserAccess=async()=>{if(t&&S){p(!0);try{var e;let s={user_id:S,access_type:E,custom_scopes:A.length>0?A:null,notes:F||null},a=await fetch("/api/v1/permissions/access/".concat(t.client_id),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(null===(e=document.cookie.match(/access_token=([^;]+)/))||void 0===e?void 0:e[1])},body:JSON.stringify(s)});if(a.ok)_(!1),C(""),P("allowed"),O([]),B(""),loadClientPermissions(t.client_id),alert("用户权限设置成功！");else throw Error("设置失败")}catch(e){console.error("Failed to grant user access:",e),alert("设置用户权限失败")}finally{p(!1)}}},revokeUserAccess=async e=>{if(t&&confirm("确定要撤销该用户的权限吗？"))try{var s;let a=await fetch("/api/v1/permissions/access/".concat(t.client_id,"/user/").concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(null===(s=document.cookie.match(/access_token=([^;]+)/))||void 0===s?void 0:s[1])}});if(a.ok)loadClientPermissions(t.client_id),alert("用户权限已撤销！");else throw Error("撤销失败")}catch(e){console.error("Failed to revoke user access:",e),alert("撤销用户权限失败")}},getScopeDescription=e=>({openid:"身份验证",profile:"基本资料",email:"邮箱地址",phone:"手机号码",address:"地址信息"})[e]||e;return u?(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"加载中..."})]})}):(0,a.jsx)("div",{className:"min-h-full py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"应用权限管理"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"管理应用的权限组和用户访问权限"})]}),0===e.length?(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-gray-100",children:(0,a.jsx)("svg",{className:"h-6 w-6 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})})}),(0,a.jsx)("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"暂无应用"}),(0,a.jsx)("p",{className:"mt-2 text-gray-500",children:"请先创建应用后再配置权限"})]}):(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"bg-white shadow rounded-lg p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"选择应用"}),(0,a.jsx)("div",{className:"space-y-2",children:e.map(e=>(0,a.jsxs)("button",{onClick:()=>r(e),className:"w-full text-left p-3 rounded-lg border transition-colors ".concat((null==t?void 0:t.id)===e.id?"bg-blue-50 border-blue-200 text-blue-900":"bg-gray-50 border-gray-200 hover:bg-gray-100"),children:[(0,a.jsx)("div",{className:"font-medium",children:e.client_name}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:e.client_description})]},e.id))})]}),t&&(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white shadow rounded-lg p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"权限组配置"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"组名称"}),(0,a.jsx)("input",{type:"text",value:g,onChange:e=>f(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"组描述"}),(0,a.jsx)("textarea",{value:v,onChange:e=>y(e.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsx)("div",{children:(0,a.jsxs)("label",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",checked:b,onChange:e=>j(e.target.checked),className:"mr-2"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"默认允许所有用户使用此应用"})]})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"允许的权限范围"}),(0,a.jsx)("div",{className:"space-y-2",children:z.map(e=>(0,a.jsxs)("label",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",checked:N.includes(e),onChange:s=>{s.target.checked?w([...N,e]):w(N.filter(s=>s!==e))},className:"mr-2"}),(0,a.jsx)("span",{className:"text-sm text-gray-700",children:getScopeDescription(e)})]},e))})]}),(0,a.jsx)("button",{onClick:savePermissionGroup,disabled:h,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:h?"保存中...":"保存权限组"})]})]}),(0,a.jsxs)("div",{className:"bg-white shadow rounded-lg p-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900",children:"用户权限管理"}),(0,a.jsx)("button",{onClick:()=>_(!0),className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"添加用户权限"})]}),0===o.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-4",children:"暂无特定用户权限设置"}):(0,a.jsx)("div",{className:"space-y-3",children:o.map(e=>{let s=d.find(s=>s.id===e.user_id);return(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:(null==s?void 0:s.username)||"未知用户"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["allowed"===e.access_type?"允许":"拒绝",e.custom_scopes&&e.custom_scopes.length>0&&(0,a.jsxs)("span",{children:[" - ",e.custom_scopes.map(getScopeDescription).join(", ")]})]}),e.notes&&(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:e.notes})]}),(0,a.jsx)("button",{onClick:()=>revokeUserAccess(e.user_id),className:"px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700",children:"撤销"})]},e.id)})})]})]})]}),k&&(0,a.jsx)("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:(0,a.jsx)("div",{className:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",children:(0,a.jsxs)("div",{className:"mt-3",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"添加用户权限"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"选择用户"}),(0,a.jsxs)("select",{value:S,onChange:e=>C(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:"",children:"请选择用户"}),d.filter(e=>!o.some(s=>s.user_id===e.id)).map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.username," (",e.email,")"]},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"访问类型"}),(0,a.jsxs)("select",{value:E,onChange:e=>P(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:"allowed",children:"允许"}),(0,a.jsx)("option",{value:"denied",children:"拒绝"})]})]}),"allowed"===E&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"自定义权限范围（可选）"}),(0,a.jsx)("div",{className:"space-y-2",children:z.map(e=>(0,a.jsxs)("label",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",checked:A.includes(e),onChange:s=>{s.target.checked?O([...A,e]):O(A.filter(s=>s!==e))},className:"mr-2"}),(0,a.jsx)("span",{className:"text-sm text-gray-700",children:getScopeDescription(e)})]},e))}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"不选择则使用权限组默认设置"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"备注（可选）"}),(0,a.jsx)("textarea",{value:F,onChange:e=>B(e.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 mt-6",children:[(0,a.jsx)("button",{onClick:()=>{_(!1),C(""),P("allowed"),O([]),B("")},className:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400",children:"取消"}),(0,a.jsx)("button",{onClick:grantUserAccess,disabled:!S||h,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:h?"设置中...":"确认"})]})]})})})]})})}},622:function(e,s,t){"use strict";/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var a=t(2265),l=Symbol.for("react.element"),r=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,c=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function q(e,s,t){var a,r={},n=null,d=null;for(a in void 0!==t&&(n=""+t),void 0!==s.key&&(n=""+s.key),void 0!==s.ref&&(d=s.ref),s)i.call(s,a)&&!o.hasOwnProperty(a)&&(r[a]=s[a]);if(e&&e.defaultProps)for(a in s=e.defaultProps)void 0===r[a]&&(r[a]=s[a]);return{$$typeof:l,type:e,key:n,ref:d,props:r,_owner:c.current}}s.Fragment=r,s.jsx=q,s.jsxs=q},7437:function(e,s,t){"use strict";e.exports=t(622)}},function(e){e.O(0,[971,472,744],function(){return e(e.s=8054)}),_N_E=e.O()}]);