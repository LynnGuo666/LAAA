(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[362],{5350:function(e,t,s){Promise.resolve().then(s.bind(s,3124))},3124:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return AuthorizePage}});var a=s(7437),r=s(2265),n=s(4033),i=s(6454);function AuthorizeContent(){let e=(0,n.useRouter)(),t=(0,n.useSearchParams)(),[s,c]=(0,r.useState)(!1),[l,o]=(0,r.useState)(""),[d,u]=(0,r.useState)(null),[m,p]=(0,r.useState)(null),[h,x]=(0,r.useState)(null),[g,y]=(0,r.useState)([]),v=t.get("username")||"",f=t.get("password")||"",j="true"===t.get("auto_login");(0,r.useEffect)(()=>{try{let e=t.get("response_type"),s=t.get("client_id"),a=t.get("redirect_uri");if(!e||!s||!a||!v||!f){o("缺少必要的授权参数");return}let r={response_type:e,client_id:s,redirect_uri:a,scope:t.get("scope")||"openid",state:t.get("state")||void 0,code_challenge:t.get("code_challenge")||void 0,code_challenge_method:t.get("code_challenge_method")||void 0,nonce:t.get("nonce")||void 0};x(r),y(r.scope?r.scope.split(" "):["openid"]),i.i.getClientInfo(s).then(e=>{u(e),j&&handleAuthorize(!0)}).catch(e=>{console.error("Failed to fetch client info:",e),o("无效的客户端应用")})}catch(e){o("解析授权参数失败")}},[t,v,f,j]);let getScopeDescription=e=>({openid:"验证您的身份",profile:"访问您的基本资料信息（姓名、用户名等）",email:"访问您的邮箱地址",phone:"访问您的手机号码",address:"访问您的地址信息"})[e]||"访问 ".concat(e," 权限"),handleAuthorize=async e=>{if(!h)return;c(!0),o("");let t=document.createElement("form");t.method="POST",t.action="/oauth/authorize";let s={username:v,password:f,client_id:h.client_id,redirect_uri:h.redirect_uri,scope:h.scope||"openid",state:h.state||"",code_challenge:h.code_challenge||"",code_challenge_method:h.code_challenge_method||"",nonce:h.nonce||"",consent:e.toString()};Object.entries(s).forEach(e=>{let[s,a]=e;if(a){let e=document.createElement("input");e.type="hidden",e.name=s,e.value=a,t.appendChild(e)}}),document.body.appendChild(t),t.submit()};return l?(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsx)("div",{className:"max-w-md w-full",children:(0,a.jsx)("div",{className:"card",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:(0,a.jsx)("svg",{className:"h-8 w-8 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),(0,a.jsx)("h2",{className:"mt-4 text-xl font-bold text-gray-900",children:"授权错误"}),(0,a.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:l}),(0,a.jsx)("button",{onClick:()=>e.push("/login"),className:"mt-4 btn-primary",children:"返回登录"})]})})})}):d&&h?(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsx)("div",{className:"max-w-md w-full",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsxs)("div",{className:"text-center mb-6",children:[(0,a.jsx)("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-primary-100",children:(0,a.jsx)("svg",{className:"h-8 w-8 text-primary-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,a.jsx)("h2",{className:"mt-4 text-xl font-bold text-gray-900",children:"授权请求"})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[d.logo_uri&&(0,a.jsx)("img",{src:d.logo_uri,alt:d.client_name,className:"h-10 w-10 rounded"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("h3",{className:"font-semibold text-gray-900",children:d.client_name}),d.client_description&&(0,a.jsx)("p",{className:"text-sm text-gray-600",children:d.client_description})]})]}),d.client_uri&&(0,a.jsx)("a",{href:d.client_uri,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-primary-600 hover:text-primary-500 mt-2 inline-block",children:"访问官网 →"})]}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h4",{className:"font-medium text-gray-900 mb-3",children:"此应用将获得以下权限："}),(0,a.jsx)("ul",{className:"space-y-2",children:g.map(e=>(0,a.jsxs)("li",{className:"flex items-center text-sm text-gray-700",children:[(0,a.jsx)("svg",{className:"h-4 w-4 text-green-500 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),getScopeDescription(e)]},e))})]}),(0,a.jsxs)("div",{className:"mb-6 text-xs text-gray-500",children:[(0,a.jsx)("p",{children:"通过授权，您同意该应用按照其隐私政策处理您的数据。"}),(0,a.jsxs)("div",{className:"mt-2 space-x-4",children:[d.policy_uri&&(0,a.jsx)("a",{href:d.policy_uri,target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-500",children:"隐私政策"}),d.tos_uri&&(0,a.jsx)("a",{href:d.tos_uri,target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-500",children:"服务条款"})]})]}),(0,a.jsxs)("div",{className:"flex space-x-4",children:[(0,a.jsx)("button",{onClick:()=>{handleAuthorize(!1)},disabled:s,className:"btn-secondary",children:"拒绝"}),(0,a.jsx)("button",{onClick:()=>{handleAuthorize(!0)},disabled:s,className:"btn-primary",children:s?"处理中...":"授权"})]}),(0,a.jsx)("div",{className:"mt-4 text-center",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["作为 ",(0,a.jsx)("span",{className:"font-medium",children:v})," 登录"]})})]})})}):(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"正在加载..."})]})})}function AuthorizePage(){return(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{className:"min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"加载中..."})]})}),children:(0,a.jsx)(AuthorizeContent,{})})}},6454:function(e,t,s){"use strict";s.d(t,{i:function(){return c}});var a=s(4829),r=s(1490);let n="".concat(window.location.protocol,"//").concat(window.location.host),i=a.Z.create({baseURL:n,headers:{"Content-Type":"application/json"}});i.interceptors.request.use(e=>{let t=r.Z.get("access_token");return t&&(e.headers.Authorization="Bearer ".concat(t)),e}),i.interceptors.response.use(e=>e,e=>{var t;return(null===(t=e.response)||void 0===t?void 0:t.status)!==401||(r.Z.remove("access_token"),r.Z.remove("refresh_token"),window.location.pathname.includes("/login")||(window.location.href="/login/")),Promise.reject(e)});let c={login:async e=>{let t=new FormData;t.append("username",e.username),t.append("password",e.password),t.append("grant_type","password");let s=await a.Z.post("".concat(n,"/oauth/token"),t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return s.data},authorize:async e=>{let t=new FormData;Object.entries(e).forEach(e=>{let[s,a]=e;null!=a&&t.append(s,a.toString())});let s=await a.Z.post("".concat(n,"/oauth/authorize"),t,{headers:{"Content-Type":"application/x-www-form-urlencoded"},maxRedirects:0,validateStatus:e=>e<400||e>=300&&e<400});return s},getCurrentUser:async()=>{let e=await i.get("/api/v1/users/me");return e.data},getClientInfo:async e=>{let t=await i.get("/api/v1/clients/".concat(e));return t.data},register:async e=>{let t=await i.post("/api/v1/users",e);return t.data},checkPermission:async(e,t,s)=>{let a=await i.post("/api/v1/permissions/check",{user_id:e,client_id:t,requested_scopes:s});return a.data},createPermissionRequest:async e=>{let t=await i.post("/api/v1/permissions/requests",e);return t.data},getMyPermissionRequests:async()=>{let e=await i.get("/api/v1/permissions/requests/my");return e.data},getUserPermissions:async e=>{let t=await i.get("/api/v1/permissions/user/".concat(e));return t.data},getAllUsers:async()=>{let e=await i.get("/api/v1/users");return e.data},getUserById:async e=>{let t=await i.get("/api/v1/users/".concat(e));return t.data},updateUser:async(e,t)=>{let s=await i.put("/api/v1/users/".concat(e),t);return s.data},deleteUser:async e=>{let t=await i.delete("/api/v1/users/".concat(e));return t.data},getAllClients:async()=>{let e=await i.get("/api/v1/clients");return e.data},updateClient:async(e,t)=>{let s=await i.put("/api/v1/clients/".concat(e),t);return s.data},deleteClient:async e=>{let t=await i.delete("/api/v1/clients/".concat(e));return t.data},createClient:async e=>{let t=await i.post("/api/v1/clients",e);return t.data},getUserPermissionsByAdmin:async e=>{let t=await i.get("/api/v1/admin/users/".concat(e,"/permissions"));return t.data},grantUserPermission:async(e,t,s)=>{let a=await i.post("/api/v1/admin/users/".concat(e,"/permissions/").concat(t),s);return a.data},revokeUserPermission:async(e,t)=>{let s=await i.delete("/api/v1/admin/users/".concat(e,"/permissions/").concat(t));return s.data},getPermissionGroups:async()=>{let e=await i.get("/api/v1/permissions/groups");return e.data},getPermissionGroup:async e=>{let t=await i.get("/api/v1/permissions/groups/".concat(e));return t.data},updatePermissionGroup:async(e,t)=>{let s=await i.put("/api/v1/permissions/groups/".concat(e),t);return s.data}}}},function(e){e.O(0,[745,971,472,744],function(){return e(e.s=5350)}),_N_E=e.O()}]);